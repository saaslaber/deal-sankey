<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pipeline — By Deal Count</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,300&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:#0f1117;color:#e4e6eb;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:40px 20px}
  .dashboard-header{text-align:center;margin-bottom:24px}
  .dashboard-header h1{font-size:28px;font-weight:700;letter-spacing:-0.5px;color:#fff;margin-bottom:6px}
  .dashboard-header p{font-size:14px;color:#6b7280;font-weight:300}
  .dashboard-header .updated{font-size:12px;color:#4b5060;margin-top:4px}
  .back-link{position:absolute;top:20px;left:24px;color:#6b7280;text-decoration:none;font-size:13px;transition:color 0.2s}
  .back-link:hover{color:#e4e6eb}
  .filter-bar{display:flex;align-items:center;gap:24px;margin-bottom:28px;width:100%;max-width:1200px;flex-wrap:wrap}
  .filter-group{display:flex;align-items:center;gap:10px}
  .filter-group label{font-size:12px;color:#6b7280;font-weight:500;text-transform:uppercase;letter-spacing:0.6px;white-space:nowrap}
  .filter-group select{background:#181a20;color:#e4e6eb;border:1px solid #2a2d36;border-radius:8px;padding:10px 36px 10px 14px;font-size:14px;font-family:'DM Sans',sans-serif;cursor:pointer;min-width:200px;transition:border-color 0.2s;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%236b7280'%3E%3Cpath d='M1 1l5 5 5-5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
  .filter-group select:hover{border-color:#6366f1}
  .filter-group select:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 2px rgba(99,102,241,0.2)}
  .deal-badge{font-size:13px;color:#9ca3af;background:#1e2028;border:1px solid #2a2d36;padding:6px 14px;border-radius:6px;margin-left:auto}
  .sankey-container{width:100%;max-width:1200px;background:#181a20;border-radius:16px;border:1px solid #2a2d36;padding:32px 16px;position:relative;overflow:visible}
  .sankey-container::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(99,102,241,0.4),transparent)}
  svg{width:100%;height:auto;display:block;overflow:visible}
  .kpi-row{display:flex;gap:14px;width:100%;max-width:1200px;margin-top:24px;flex-wrap:wrap}
  .kpi-card{flex:1;min-width:140px;background:#181a20;border:1px solid #2a2d36;border-radius:12px;padding:20px 24px;position:relative;overflow:hidden;transition:border-color 0.3s;cursor:pointer}
  .kpi-card:hover{border-color:#3b3f4a}
  .kpi-card .accent-bar{position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
  .kpi-card .label{font-size:12px;font-weight:500;color:#6b7280;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px}
  .kpi-card .value{font-size:32px;font-weight:700;color:#fff;line-height:1}
  .kpi-card .sub{font-size:13px;color:#e4e6eb;margin-top:6px;font-weight:300}
  .tooltip{position:fixed;background:#1e2028;border:1px solid #3b3f4a;border-radius:8px;padding:12px 16px;font-size:13px;color:#e4e6eb;pointer-events:none;opacity:0;transition:opacity 0.15s;z-index:100;box-shadow:0 8px 32px rgba(0,0,0,0.4);max-width:280px}
  .tooltip.visible{opacity:1}
  .tooltip .tt-label{font-weight:700;margin-bottom:4px}
  .tooltip .tt-value{color:#9ca3af;font-weight:300}
  .legend{display:flex;gap:24px;justify-content:center;margin-top:20px;width:100%;max-width:1200px}
  .legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:#6b7280}
  .legend-dot{width:10px;height:10px;border-radius:50%}
  .flow-path{transition:opacity 0.2s;cursor:pointer}
  .flow-path:hover{opacity:1!important}
  .node-rect{cursor:pointer;transition:opacity 0.15s}
  .node-rect:hover{opacity:0.85}
  .loading{display:flex;align-items:center;justify-content:center;height:300px;color:#6b7280;font-size:15px}
  .loading .spinner{width:20px;height:20px;border:2px solid #2a2d36;border-top-color:#6366f1;border-radius:50%;animation:spin 0.8s linear infinite;margin-right:12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .error-msg{text-align:center;color:#f97316;padding:40px;font-size:14px}
  .no-data-msg{text-align:center;color:#6b7280;padding:80px 40px;font-size:16px}
  .click-hint{font-size:11px;color:#4b5060;text-align:center;margin-top:12px;width:100%;max-width:1200px}
  .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:500;align-items:flex-end;justify-content:center;backdrop-filter:blur(2px)}
  .drawer-overlay.open{display:flex}
  .drawer{background:#181a20;border:1px solid #2a2d36;border-radius:16px 16px 0 0;width:100%;max-width:1400px;max-height:80vh;display:flex;flex-direction:column;animation:slideUp 0.25s ease-out}
  @keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
  .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid #2a2d36;flex-shrink:0}
  .drawer-header h2{font-size:18px;font-weight:700;color:#fff;display:flex;align-items:center;gap:10px}
  .drawer-header .badge{font-size:13px;font-weight:500;padding:4px 12px;border-radius:20px}
  .drawer-close{background:none;border:1px solid #2a2d36;color:#9ca3af;border-radius:8px;width:36px;height:36px;font-size:18px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center}
  .drawer-close:hover{background:#2a2d36;color:#fff}
  .drawer-body{overflow-y:auto;padding:0 28px 24px;flex:1}
  .drawer-table{width:100%;border-collapse:collapse;margin-top:16px;font-size:13px}
  .drawer-table thead{position:sticky;top:0;z-index:2}
  .drawer-table th{text-align:left;padding:10px 12px;background:#1e2028;color:#6b7280;font-weight:600;text-transform:uppercase;font-size:11px;letter-spacing:0.6px;border-bottom:1px solid #2a2d36;white-space:nowrap}
  .drawer-table td{padding:10px 12px;border-bottom:1px solid #1e2028;color:#d1d5db;max-width:220px;overflow:hidden;text-overflow:ellipsis}
  .drawer-table tr:hover td{background:rgba(99,102,241,0.06)}
  .drawer-table .amt{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
  .drawer-summary{display:flex;gap:28px;padding:16px 0 0;font-size:13px;color:#9ca3af}
  .drawer-summary strong{color:#e4e6eb}
</style>
</head>
<body>
<a class="back-link" href="index.html">← Back to dashboard</a>

<div class="dashboard-header">
  <h1>Deal Pipeline Flow — By Count</h1>
  <p>S1 → S2 Qualification → Outcome</p>
  <div class="updated" id="lastUpdated"></div>
</div>

<div class="filter-bar">
  <div class="filter-group">
    <label>Period</label>
    <select id="periodSelect">
      <option value="this_quarter">This Quarter</option>
      <option value="last_quarter">Last Quarter</option>
      <option value="this_month">This Month</option>
      <option value="last_month">Last Month</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Deal Owner</label>
    <select id="ownerSelect"><option value="_all">All Owners</option></select>
  </div>
  <span class="deal-badge" id="dealCount"></span>
</div>

<div class="sankey-container">
  <div class="loading" id="loadingState"><div class="spinner"></div>Fetching latest data…</div>
  <svg id="sankey" viewBox="0 0 1200 440" style="display:none"></svg>
</div>

<div class="click-hint" id="clickHint" style="display:none">Click any node or flow to view the underlying deals</div>

<div class="legend" id="legend" style="display:none">
  <div class="legend-item"><div class="legend-dot" style="background:#6366f1"></div>S1 → S2 (Qualified)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div>Closed Lost</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Closed Won</div>
</div>

<div class="kpi-row" id="kpis"></div>

<div class="tooltip" id="tooltip"><div class="tt-label"></div><div class="tt-value"></div></div>

<div class="drawer-overlay" id="drawerOverlay">
  <div class="drawer">
    <div class="drawer-header">
      <h2 id="drawerTitle">Deals</h2>
      <button class="drawer-close" id="drawerClose">✕</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-summary" id="drawerSummary"></div>
      <table class="drawer-table"><thead id="drawerThead"></thead><tbody id="drawerTbody"></tbody></table>
    </div>
  </div>
</div>

<script>
const COUNTS_CSV_URL = "PASTE_SANKEY_BY_OWNER_CSV_URL_HERE";
const DEALS_CSV_URL  = "PASTE_SANKEY_DEALS_CSV_URL_HERE";

const ALLOWED_OWNERS = ["Manmeet Saluja","Swapnil Dwivedi","Rohan Verma","Yash Chandra","Rohit Lakhanpal","Verity","Abhijeet Srivastava","Sneha Agarwal","Erin Dean","Rishabh Bhushan","Rory Costello"];

let COUNTS={}, DEALS=[];

async function fetchAllData(){
  const [c,d]=await Promise.all([fetch(COUNTS_CSV_URL),fetch(DEALS_CSV_URL)]);
  if(!c.ok)throw new Error("Counts CSV: HTTP "+c.status);
  if(!d.ok)throw new Error("Deals CSV: HTTP "+d.status);
  COUNTS=parseCounts(await c.text());
  DEALS=parseDeals(await d.text());
}

function clean(s){return(s||'').trim().replace(/^"|"$/g,'')}

function parseCounts(csv){
  const lines=csv.trim().split("\n").map(l=>l.split(",").map(clean));
  const data={};
  for(let i=1;i<lines.length;i++){
    const r=lines[i];if(r.length<6)continue;
    const[period,owner,source,target,countStr]=r;
    if(!period||!owner)continue;
    const count=parseInt(countStr,10)||0;
    if(!data[period])data[period]={};
    if(!data[period][owner])data[period][owner]={s1_to_cl:0,s1_to_s2:0,s2_to_cw:0,s2_to_cl:0};
    const d=data[period][owner],sl=source.toLowerCase(),tl=target.toLowerCase();
    if(sl.includes("s1")&&tl.includes("closed lost"))d.s1_to_cl=count;
    else if(sl.includes("s1")&&tl.includes("s2"))d.s1_to_s2=count;
    else if(sl.includes("s2")&&tl.includes("closed won"))d.s2_to_cw=count;
    else if(sl.includes("s2")&&tl.includes("closed lost"))d.s2_to_cl=count;
  }
  return data;
}

function splitRow(line){const f=[];let c='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){q=!q;continue}if(ch===','&&!q){f.push(c.trim());c='';continue}c+=ch}f.push(c.trim());return f}

function parseDeals(csv){
  const lines=csv.trim().split("\n"),deals=[];
  for(let i=1;i<lines.length;i++){
    const r=splitRow(lines[i]);if(r.length<12)continue;
    deals.push({period:r[0],owner:r[1],bucket:r[2],dealname:r[3],amount:r[4],closedate:r[5],subscription_type:r[6],loss_reason:r[7],secondary_loss:r[8],win_reason:r[9],secondary_win:r[10],ae_notes:r[11]||""});
  }
  return deals;
}

const COL={s1:'#6366f1',s2:'#8b5cf6',won:'#22c55e',lost:'#f97316',flowS1S2:'rgba(99,102,241,0.28)',flowS1Lost:'rgba(249,115,22,0.22)',flowS2Won:'rgba(34,197,94,0.28)',flowS2Lost:'rgba(249,115,22,0.22)'};
const W=1200,H=440,nodeW=28,padL=160,padR=160;

function el(tag,a={}){const e=document.createElementNS('http://www.w3.org/2000/svg',tag);for(const[k,v] of Object.entries(a))e.setAttribute(k,v);return e}

function cubicFlow(x0,y0t,y0b,x1,y1t,y1b,fill,hL,hV,bk){
  const mx=(x0+x1)/2,d=`M${x0},${y0t} C${mx},${y0t} ${mx},${y1t} ${x1},${y1t} L${x1},${y1b} C${mx},${y1b} ${mx},${y0b} ${x0},${y0b} Z`;
  const p=el('path',{d,fill,class:'flow-path',opacity:'0.7'});
  p.addEventListener('mouseenter',e=>{p.setAttribute('opacity','0.95');showTT(e,hL,hV)});
  p.addEventListener('mousemove',e=>moveTT(e));
  p.addEventListener('mouseleave',()=>{p.setAttribute('opacity','0.7');hideTT()});
  p.addEventListener('click',()=>openDrawer(bk,hL));
  return p;
}

function drawNode(n){
  const g=el('g');
  g.appendChild(el('rect',{x:n.x-4,y:n.y-4,width:nodeW+8,height:n.h+8,rx:8,fill:n.color,opacity:0.12,filter:'url(#glow)'}));
  const rect=el('rect',{x:n.x,y:n.y,width:nodeW,height:n.h,rx:4,fill:n.color,class:'node-rect'});
  rect.addEventListener('click',()=>openDrawer(n.buckets,n.label));
  g.appendChild(rect);
  const mid=(padL+(W-padR-nodeW))/2,isR=n.x>W/2,isC=Math.abs(n.x-mid)<60;
  const lx=(isC||isR)?n.x+nodeW+16:n.x-16,anc=(isC||isR)?'start':'end',ly=n.y+n.h/2;
  const t1=el('text',{x:lx,y:ly-10,'text-anchor':anc,fill:'#e4e6eb','font-size':'15','font-weight':'700','font-family':'DM Sans,sans-serif'});
  t1.textContent=n.label;g.appendChild(t1);
  const t2=el('text',{x:lx,y:ly+10,'text-anchor':anc,fill:'#6b7280','font-size':'13','font-weight':'300','font-family':'DM Sans,sans-serif'});
  t2.textContent=n.count.toLocaleString()+' deals';g.appendChild(t2);
  return g;
}

const ttEl=document.getElementById('tooltip');
function showTT(e,l,v){ttEl.querySelector('.tt-label').textContent=l;ttEl.querySelector('.tt-value').textContent=v;ttEl.classList.add('visible');moveTT(e)}
function moveTT(e){ttEl.style.left=(e.clientX+16)+'px';ttEl.style.top=(e.clientY-10)+'px'}
function hideTT(){ttEl.classList.remove('visible')}

function getFilteredDeals(bk){
  const period=document.getElementById('periodSelect').value,owner=document.getElementById('ownerSelect').value;
  return DEALS.filter(d=>{
    if(d.period!==period)return false;
    if(owner!=='_all'&&d.owner!==owner)return false;
    return bk.some(b=>d.bucket.toLowerCase().includes(b));
  });
}

function openDrawer(bk,title){
  const deals=getFilteredDeals(bk);
  const overlay=document.getElementById('drawerOverlay');
  const isWon=bk.some(b=>b.includes('won')),isLost=bk.some(b=>b.includes('lost'));

  document.getElementById('drawerTitle').innerHTML=`${title} <span class="badge" style="background:${isWon?'rgba(34,197,94,0.15);color:#22c55e':isLost?'rgba(249,115,22,0.15);color:#f97316':'rgba(99,102,241,0.15);color:#6366f1'}">${deals.length} deals</span>`;

  const totalAmt=deals.reduce((s,d)=>s+(parseFloat(d.amount)||0),0);
  document.getElementById('drawerSummary').innerHTML=`<span><strong>${deals.length}</strong> deals</span><span>Total: <strong>${fmtCur(totalAmt)}</strong></span>`;

  let cols=['Deal Name','Amount','Close Date','Owner','Subscription Type'];
  if(isLost)cols.push('Loss Reason','Secondary Loss','AE Notes');
  if(isWon)cols.push('Win Reason','Secondary Win','AE Notes');
  if(!isWon&&!isLost)cols.push('Loss Reason','Win Reason','AE Notes');

  document.getElementById('drawerThead').innerHTML='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  document.getElementById('drawerTbody').innerHTML=deals.map(d=>{
    let cells=[`<td title="${esc(d.dealname)}">${esc(d.dealname)}</td>`,`<td class="amt">${fmtCur(parseFloat(d.amount)||0)}</td>`,`<td>${esc(d.closedate)}</td>`,`<td>${esc(d.owner)}</td>`,`<td>${esc(d.subscription_type)}</td>`];
    if(isLost){cells.push(`<td title="${esc(d.loss_reason)}">${esc(d.loss_reason)}</td>`,`<td>${esc(d.secondary_loss)}</td>`,`<td title="${esc(d.ae_notes)}">${esc(d.ae_notes)}</td>`)}
    if(isWon){cells.push(`<td title="${esc(d.win_reason)}">${esc(d.win_reason)}</td>`,`<td>${esc(d.secondary_win)}</td>`,`<td title="${esc(d.ae_notes)}">${esc(d.ae_notes)}</td>`)}
    if(!isWon&&!isLost){cells.push(`<td>${esc(d.loss_reason)}</td>`,`<td>${esc(d.win_reason)}</td>`,`<td title="${esc(d.ae_notes)}">${esc(d.ae_notes)}</td>`)}
    return '<tr>'+cells.join('')+'</tr>';
  }).join('');
  overlay.classList.add('open');
}

function closeDrawer(){document.getElementById('drawerOverlay').classList.remove('open')}
function esc(s){if(!s)return'—';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fmtCur(n){return n.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0})}

document.getElementById('drawerClose').addEventListener('click',closeDrawer);
document.getElementById('drawerOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeDrawer()});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDrawer()});

function renderSankey(d){
  const svg=document.getElementById('sankey');svg.innerHTML='';
  const TOTAL=d.s1_to_cl+d.s1_to_s2;
  const container=document.querySelector('.sankey-container');
  let noData=container.querySelector('.no-data-msg');
  if(TOTAL===0){svg.style.display='none';document.getElementById('kpis').innerHTML='';if(!noData){noData=document.createElement('div');noData.className='no-data-msg';container.appendChild(noData)}noData.textContent='No deals found for this selection.';noData.style.display='block';document.getElementById('dealCount').textContent='0 deals';return}
  if(noData)noData.style.display='none';svg.style.display='block';

  const s2Ratio=d.s1_to_s2/TOTAL,clDirRatio=d.s1_to_cl/TOTAL,totalCL=d.s1_to_cl+d.s2_to_cl;
  const wonRatio=d.s2_to_cw/(d.s1_to_s2||1),lostS2Ratio=d.s2_to_cl/(d.s1_to_s2||1);
  const cwOfS1=(d.s2_to_cw/TOTAL*100).toFixed(1);

  const leftX=padL,midX=W/2-nodeW/2,rightX=W-padR-nodeW;
  const topY=30,botY=H-30,uH=botY-topY;

  const s1={x:leftX,y:topY,h:uH,label:'S1 (All Deals)',color:COL.s1,count:TOTAL,buckets:['s1 to closed lost','s2 to closed won','s2 to closed lost']};
  const s2H=uH*s2Ratio;
  const s2={x:midX,y:botY-s2H,h:s2H,label:'S2 (Qualified)',color:COL.s2,count:d.s1_to_s2,buckets:['s2 to closed won','s2 to closed lost']};
  const clR=totalCL/TOTAL,cwR=d.s2_to_cw/TOTAL,gap=24;
  const clH=Math.max(uH*(clR/(clR+cwR+0.05)),24),cwH=Math.max(uH-clH-gap,24);
  const closedLost={x:rightX,y:topY,h:clH,label:'Closed Lost',color:COL.lost,count:totalCL,buckets:['closed lost']};
  const closedWon={x:rightX,y:topY+clH+gap,h:cwH,label:'Closed Won',color:COL.won,count:d.s2_to_cw,buckets:['closed won']};

  const defs=el('defs');const blur=el('filter',{id:'glow'});blur.appendChild(el('feGaussianBlur',{in:'SourceGraphic',stdDeviation:'8'}));defs.appendChild(blur);svg.appendChild(defs);

  const s1cb=s1.y+uH*clDirRatio,cldp=totalCL>0?(d.s1_to_cl/totalCL)*closedLost.h:0;

  svg.appendChild(cubicFlow(s1.x+nodeW,s1.y,s1cb,closedLost.x,closedLost.y,closedLost.y+cldp,COL.flowS1Lost,'S1 → Closed Lost (Direct)',d.s1_to_cl+' deals · '+(clDirRatio*100).toFixed(1)+'% of S1',['s1 to closed lost']));
  svg.appendChild(cubicFlow(s1.x+nodeW,s1cb,s1.y+uH,s2.x,s2.y,s2.y+s2.h,COL.flowS1S2,'S1 → S2 (Qualified)',d.s1_to_s2+' deals · '+(s2Ratio*100).toFixed(1)+'% of S1',['s2 to closed won','s2 to closed lost']));
  const s2cs=s2.y+s2.h*lostS2Ratio;
  svg.appendChild(cubicFlow(s2.x+nodeW,s2.y,s2cs,closedLost.x,closedLost.y+cldp,closedLost.y+closedLost.h,COL.flowS2Lost,'S2 → Closed Lost',d.s2_to_cl+' deals · '+(lostS2Ratio*100).toFixed(1)+'% of S2',['s2 to closed lost']));
  svg.appendChild(cubicFlow(s2.x+nodeW,s2cs,s2.y+s2.h,closedWon.x,closedWon.y,closedWon.y+closedWon.h,COL.flowS2Won,'S2 → Closed Won',d.s2_to_cw+' deals · '+(wonRatio*100).toFixed(1)+'% of S2',['s2 to closed won']));

  [s1,s2,closedLost,closedWon].forEach(n=>svg.appendChild(drawNode(n)));

  const kpiRow=document.getElementById('kpis');kpiRow.innerHTML='';
  [
    {label:'Total S1 Deals',value:TOTAL,sub:'100% of pipeline',color:COL.s1,buckets:['s1 to closed lost','s2 to closed won','s2 to closed lost']},
    {label:'Qualified (S2)',value:d.s1_to_s2,sub:(s2Ratio*100).toFixed(1)+'% qualification rate',color:COL.s2,buckets:['s2 to closed won','s2 to closed lost']},
    {label:'Closed Won',value:d.s2_to_cw,sub:(wonRatio*100).toFixed(1)+'% win rate (of S2)',color:COL.won,buckets:['closed won']},
    {label:'CW % of S1',value:cwOfS1+'%',sub:d.s2_to_cw+' won of '+TOTAL+' total',color:'#10b981',buckets:['closed won']},
    {label:'Total Lost',value:totalCL,sub:d.s1_to_cl+' direct + '+d.s2_to_cl+' from S2',color:COL.lost,buckets:['closed lost']},
  ].forEach(k=>{
    const card=document.createElement('div');card.className='kpi-card';
    card.innerHTML=`<div class="accent-bar" style="background:${k.color}"></div><div class="label">${k.label}</div><div class="value">${typeof k.value==='number'?k.value.toLocaleString():k.value}</div><div class="sub">${k.sub}</div>`;
    card.addEventListener('click',()=>openDrawer(k.buckets,k.label));
    kpiRow.appendChild(card);
  });
  document.getElementById('dealCount').textContent=TOTAL.toLocaleString()+' deals';
}

function getSelectedData(){const p=document.getElementById('periodSelect').value,o=document.getElementById('ownerSelect').value;return(COUNTS[p]||{})[o]||null}
function refreshChart(){const d=getSelectedData();renderSankey(d||{s1_to_cl:0,s1_to_s2:0,s2_to_cw:0,s2_to_cl:0})}

function populateOwnerDropdown(){
  const sel=document.getElementById('ownerSelect'),period=document.getElementById('periodSelect').value,pd=COUNTS[period]||{},cur=sel.value;
  sel.innerHTML='<option value="_all">All Owners</option>';
  ALLOWED_OWNERS.filter(name=>pd[name]).sort().forEach(name=>{
    const d=pd[name],total=d.s1_to_cl+d.s1_to_s2;
    const opt=document.createElement('option');opt.value=name;opt.textContent=name+' ('+total+')';sel.appendChild(opt);
  });
  sel.value=pd[cur]?cur:'_all';
}

function setupFilters(){
  document.getElementById('periodSelect').addEventListener('change',()=>{populateOwnerDropdown();refreshChart()});
  document.getElementById('ownerSelect').addEventListener('change',refreshChart);
}

(async function init(){
  const loadEl=document.getElementById('loadingState'),svgEl=document.getElementById('sankey'),legEl=document.getElementById('legend'),hintEl=document.getElementById('clickHint');
  try{
    await fetchAllData();
    const periods=Object.keys(COUNTS);if(periods.length===0)throw new Error("No data found");
    document.getElementById('periodSelect').value=COUNTS['this_quarter']?'this_quarter':periods[0];
    loadEl.style.display='none';svgEl.style.display='block';legEl.style.display='flex';hintEl.style.display='block';
    setupFilters();populateOwnerDropdown();refreshChart();
    document.getElementById('lastUpdated').textContent='Live from Google Sheets · loaded '+new Date().toLocaleString();
  }catch(err){
    loadEl.innerHTML=`<div class="error-msg"><p>Could not load data.</p><p style="margin-top:8px;font-size:12px;color:#6b7280">Publish "Sankey By Owner" and "Sankey Deals" sheets as CSV.<br>${err.message}</p></div>`;
  }
})();
</script>
</body>
</html>
